name: Principal Engineer Agent

# Triggered when Code Agent gets stuck and escalates
# This agent takes a holistic approach to fix the factory, not just the symptom

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to investigate'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  checks: read
  id-token: write

concurrency:
  group: principal-engineer-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: false

jobs:
  investigate:
    # Only trigger on needs-principal-engineer label (escalation from Code Agent)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'needs-principal-engineer')
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}

      # TODO: Add your project's setup steps here
      # Examples:
      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      # - uses: astral-sh/setup-uv@v6
      # - run: npm ci
      # - run: uv sync

      - name: Get issue context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUM="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          # Get issue author
          ISSUE_AUTHOR=$(gh issue view "$ISSUE_NUM" --json author --jq '.author.login' 2>/dev/null || echo "")
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT

      - name: Update status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.context.outputs.number }} \
            --remove-label "needs-principal-engineer" \
            --remove-label "status:awaiting-human" \
            --add-label "status:bot-working" 2>/dev/null || true

      - name: Create investigation comment
        id: progress
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="## üîß Principal Engineer Investigation

          The Code Agent got stuck on this issue. I'm taking a holistic look at what went wrong.

          - [ ] üìñ Reading full issue history and understanding context
          - [ ] üìä Analyzing CI failures and downloading artifacts
          - [ ] üîç Identifying root cause (code bug vs infrastructure vs workflow)
          - [ ] üõ†Ô∏è Implementing fix
          - [ ] üè≠ Updating factory to prevent recurrence
          - [ ] ‚úÖ Verifying fix works

          **Status:** Starting investigation...
          **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *I focus on fixing the factory, not just the symptom.*

          cc @${{ steps.context.outputs.issue_author }}"

          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ steps.context.outputs.number }}/comments \
            -X POST -f body="$COMMENT_BODY" --jq '.id')

          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT

      - name: Run Principal Engineer
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            # Principal Engineer Mode

            You are the **Principal Engineer** - called in when the Code Agent gets stuck.
            Your job is to fix the FACTORY, not just the symptom.

            Read CLAUDE.md first - pay special attention to "Human intervention = factory bug".

            ## Your Philosophy
            - If the Code Agent got stuck, that's a bug in the factory
            - Fix the immediate issue AND prevent recurrence
            - You have broader permissions - can modify workflows, CLAUDE.md, agent prompts
            - Be thorough but autonomous - don't ask for help unless truly stuck

            ## Decision-Making Autonomy (CRITICAL!)

            **You are empowered to make technical decisions.** Don't ask "Should I do A, B, or C?" - DECIDE.

            ### When to Decide Autonomously (DO THIS):
            - **Implementation approach** - Pick the cleanest solution
            - **Test strategy** - Decide what tests are needed
            - **Timeout/retry values** - Use reasonable defaults (30s timeout, 3 retries)
            - **Dependency versions** - Pin to latest stable
            - **Code style** - Follow existing patterns
            - **PR merge strategy** - Wait for CI, don't merge with failures
            - **Branch management** - Always use feature branches, never push to main

            ### When to Actually Escalate to Human (RARE):
            - **Security decisions** - Credentials, auth changes, API keys
            - **Breaking changes** - Public API changes affecting users
            - **Business logic** - Product decisions, not technical ones
            - **Architecture** - Major system redesign (not refactoring)
            - **Cost implications** - New services, paid APIs

            ### The 10-Minute Rule
            If you've been stuck on a DECISION (not implementation) for 10 minutes, MAKE A CHOICE.
            Document your reasoning. A reasonable choice made quickly > perfect choice never made.

            ## üìã LOG ANALYSIS PROTOCOL (MANDATORY!)

            **BEFORE implementing ANY fix, you MUST analyze logs.** Don't guess - READ THE ACTUAL ERRORS!

            ### Step 1: Check Issue Comments for Previous Failures
            ```bash
            gh issue view ${{ steps.context.outputs.number }} --comments
            ```
            Look for "‚ùå CI Failed" comments - they contain ACTUAL failure logs.

            ### Step 2: Get Workflow Logs
            ```bash
            gh run list --workflow=ci.yml --status=failure --limit 5 --json databaseId,headBranch,conclusion
            gh run view <RUN_ID> --log-failed
            ```

            ### Step 3: Download E2E Artifacts (if E2E tests failed)
            ```bash
            gh run download <RUN_ID> --name e2e-debug-logs --dir /tmp/e2e-logs 2>/dev/null
            cat /tmp/e2e-logs/backend.log 2>/dev/null | tail -200
            ls -la /tmp/e2e-logs/ 2>/dev/null
            ```

            ## Investigation Process

            ### Step 1: Understand What Happened
            - Why did Code Agent escalate? (timeout? 3x CI failure? needed decision?)
            - What approaches were already tried?
            - Check for related PRs

            ### Step 2: Identify Root Cause Category
            **A) Code Bug** - The actual feature/fix has a bug
            **B) Test Infrastructure** - E2E setup, timeouts, flaky tests
            **C) Workflow/Agent Issue** - Code Agent prompt unclear, missing capabilities
            **D) Architecture/Design** - Needs rethinking the approach

            ### Step 3: Implement Fix
            - Create branch: `git checkout -b fix/${{ steps.context.outputs.number }}-pe-fix`
            - Make necessary changes
            - Run quality gates
            - Create PR with "Fixes #${{ steps.context.outputs.number }}" in body

            ### Step 4: Prevent Recurrence (CRITICAL!)
            **Always ask:** "How do I prevent this class of problem from happening again?"

            Options:
            - Update workflow prompts in `.github/workflows/bug-fix.yml`
            - Add rules to `CLAUDE.md`
            - Improve E2E test infrastructure in `ci.yml`
            - Add better error handling to code

            ## Progress Comment Format
            Update comment #${{ steps.progress.outputs.comment_id }} as you work:
            ```bash
            gh api repos/${{ github.repository }}/issues/comments/${{ steps.progress.outputs.comment_id }} \
              -X PATCH -f body="## üîß Principal Engineer Investigation

            - [x] üìñ Reading full issue history
            - [x] üìä Analyzing CI failures
            - [x] üîç Identifying root cause
            - [ ] üõ†Ô∏è Implementing fix
            - [ ] üè≠ Updating factory
            - [ ] ‚úÖ Verifying fix

            **Status:** [current status]

            ---
            ## üîç Root Cause Analysis
            [What happened, why, and how to prevent]

            cc @${{ steps.context.outputs.issue_author }}"
            ```

            ## Git Commit Rules
            - Use "Relates to #${{ steps.context.outputs.number }}" in commits
            - Use "Fixes #${{ steps.context.outputs.number }}" only in PR description
            - NEVER push directly to main

            ## If Truly Stuck
            After trying multiple approaches, if you really can't fix it:
            1. Document everything you tried
            2. Explain what additional information or decisions are needed
            3. Add label: needs-human
            4. Set label: status:awaiting-human

            But try HARD before escalating - you're the last line of defense!

          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: 55
          claude_args: |
            --model claude-opus-4-5-20250514
            --dangerously-skip-permissions
            --allowedTools "Bash(gh:*),Bash(git:*),Bash(npm:*),Bash(cd:*),Bash(uv:*),Bash(cat:*),Bash(ls:*),Read,Write,Edit,Glob,Grep"
        env:
          GH_TOKEN: ${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}
          GITHUB_TOKEN: ${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}

      - name: Update status on success
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.context.outputs.number }} \
            --remove-label "status:bot-working" 2>/dev/null || true

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROGRESS_COMMENT_ID: ${{ steps.progress.outputs.comment_id }}
          ISSUE_AUTHOR: ${{ steps.context.outputs.issue_author }}
        run: |
          if [ -n "$PROGRESS_COMMENT_ID" ]; then
            gh api repos/${{ github.repository }}/issues/comments/$PROGRESS_COMMENT_ID \
              -X PATCH -f body="## üîß Principal Engineer Investigation

          - [x] üìñ Reading full issue history
          - [?] Investigation incomplete (workflow failed)

          **Status:** ‚ùå Workflow failed - see logs
          **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          Even the Principal Engineer got stuck. This issue needs human review.

          cc @${ISSUE_AUTHOR}" 2>/dev/null || true
          fi

          gh issue comment ${{ steps.context.outputs.number }} --body "## üö® Principal Engineer Also Stuck

          The Principal Engineer agent was unable to resolve this issue automatically.

          **Next steps:**
          1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. This likely needs human investigation

          cc @${ISSUE_AUTHOR}"

          gh issue edit ${{ steps.context.outputs.number }} \
            --remove-label "status:bot-working" \
            --add-label "needs-human" \
            --add-label "status:awaiting-human"
