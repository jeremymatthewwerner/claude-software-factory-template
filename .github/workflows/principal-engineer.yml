name: Principal Engineer Agent

# Triggered when Code Agent gets stuck and escalates
# This agent takes a holistic approach to fix the factory, not just the symptom

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to investigate'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  checks: read
  id-token: write

concurrency:
  group: principal-engineer-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: false

jobs:
  investigate:
    # Triggers on:
    # 1. @pe or @principal-engineer mention in comment
    # 2. Manual workflow dispatch
    # SKIP if: factory-meta label is present (handled by Factory Manager only)
    # NOTE: Legacy needs-principal-engineer label trigger removed - use @pe mention instead
    if: |
      !contains(github.event.issue.labels.*.name, 'factory-meta') &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'issue_comment' &&
        !github.event.issue.pull_request &&
        (contains(github.event.comment.body, '@pe') ||
         contains(github.event.comment.body, '@PE') ||
         contains(github.event.comment.body, '@principal-engineer'))))
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}

      # Configure git to use PAT for push operations (enables pushing workflow files)
      # The checkout action embeds the token in the remote URL, so we must replace it
      - name: Configure git with PAT
        run: |
          # Remove the embedded token from the remote URL (checkout embeds ghs_* token)
          git remote set-url origin https://github.com/${{ github.repository }}.git
          # Set extraheader with PAT that has workflow scope
          git config --local http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n 'x-access-token:${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}' | base64)"

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        continue-on-error: true

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install 3.11

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci || true

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync || true

      - name: Get issue context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUM="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          echo "number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          # Get issue author
          ISSUE_AUTHOR=$(gh issue view "$ISSUE_NUM" --json author --jq '.author.login' 2>/dev/null || echo "")
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT

      - name: Update status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.context.outputs.number }} \
            --remove-label "needs-principal-engineer" \
            --remove-label "status:awaiting-human" \
            --add-label "status:bot-working" 2>/dev/null || true

      - name: Create investigation comment
        id: progress
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="## üîß Principal Engineer Investigation

          The Code Agent got stuck on this issue. I'm taking a holistic look at what went wrong.

          - [ ] üìñ Reading full issue history and understanding context
          - [ ] üìä Analyzing CI failures and downloading artifacts
          - [ ] üîç Identifying root cause (code bug vs infrastructure vs workflow)
          - [ ] üõ†Ô∏è Implementing fix
          - [ ] üè≠ Updating factory to prevent recurrence
          - [ ] ‚úÖ Verifying fix works

          **Status:** Starting investigation...
          **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *I focus on fixing the factory, not just the symptom.*

          cc @${{ steps.context.outputs.issue_author }}"

          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ steps.context.outputs.number }}/comments \
            -X POST -f body="$COMMENT_BODY" --jq '.id')

          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT

      - name: Run Principal Engineer
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            # Principal Engineer Mode

            You are the **Principal Engineer** - called in when the Code Agent gets stuck.
            Your job is to fix the FACTORY, not just the symptom.

            Read CLAUDE.md first - pay special attention to "Human intervention = factory bug".

            ## Your Philosophy
            - If the Code Agent got stuck, that's a bug in the factory
            - Fix the immediate issue AND prevent recurrence
            - You have broader permissions - can modify workflows, CLAUDE.md, agent prompts
            - Be thorough but autonomous - don't ask for help unless truly stuck

            ## Decision-Making Autonomy (CRITICAL!)

            **You are empowered to make technical decisions.** Don't ask "Should I do A, B, or C?" - DECIDE.

            ### Case Study: Issue #84
            The Code Agent got stuck and asked: "Should I A) Create new issue, B) Close PR, or C) Merge anyway?"
            This was WRONG. It should have DECIDED based on engineering judgment.

            ### When to Decide Autonomously (DO THIS):
            - **Implementation approach** - Pick the cleanest solution
            - **Test strategy** - Decide what tests are needed
            - **Timeout/retry values** - Use reasonable defaults (30s timeout, 3 retries)
            - **Dependency versions** - Pin to latest stable
            - **Code style** - Follow existing patterns
            - **PR merge strategy** - Wait for CI, don't merge with failures
            - **Branch management** - Always use feature branches, never push to main

            ### When to Actually Escalate to Human (RARE):
            - **Security decisions** - Credentials, auth changes, API keys
            - **Breaking changes** - Public API changes affecting users
            - **Business logic** - Product decisions, not technical ones
            - **Architecture** - Major system redesign (not refactoring)
            - **Cost implications** - New services, paid APIs

            ### The 10-Minute Rule
            If you've been stuck on a DECISION (not implementation) for 10 minutes, MAKE A CHOICE.
            Document your reasoning. A reasonable choice made quickly > perfect choice never made.

            ## Investigation Process

            ### Step 1: Understand What Happened
            Update progress comment, then:
            ```bash
            # Read FULL issue history
            gh issue view ${{ steps.context.outputs.number }} --comments

            # Check for related PRs
            gh pr list --search "head:fix/${{ steps.context.outputs.number }}" --state all --json number,title,state,headRefName
            gh pr list --search "head:feat/${{ steps.context.outputs.number }}" --state all --json number,title,state,headRefName
            ```

            Look for:
            - Why did Code Agent escalate? (timeout? 3x CI failure? needed decision?)
            - What approaches were already tried?
            - Any "‚ùå CI Failed" comments with logs?

            ### Step 2: Get E2E/CI Artifacts (CRITICAL!)
            If there were E2E failures, download and analyze the artifacts:
            ```bash
            # Find the failed CI run
            gh run list --workflow=ci.yml --status=failure --limit 5 --json databaseId,headBranch,conclusion

            # Download artifacts from failed run
            gh run download <RUN_ID> --name e2e-debug-logs --dir /tmp/e2e-logs 2>/dev/null || echo "No artifacts"

            # Read backend logs
            cat /tmp/e2e-logs/backend.log 2>/dev/null || echo "No backend logs"

            # Check Playwright report
            ls -la /tmp/e2e-logs/ 2>/dev/null || echo "No E2E artifacts"
            ```

            The backend logs often reveal the REAL issue (API errors, exceptions, timeouts).

            ### Step 3: Identify Root Cause Category
            Determine which type of problem this is:

            **A) Code Bug** - The actual feature/fix has a bug
            - Fix the code, update tests

            **B) Test Infrastructure** - E2E setup, timeouts, flaky tests
            - Fix test infrastructure in ci.yml or test files
            - Update CLAUDE.md with learnings

            **C) Workflow/Agent Issue** - Code Agent prompt unclear, missing capabilities
            - Update bug-fix.yml prompts
            - Add missing instructions to CLAUDE.md

            **D) Architecture/Design** - Needs rethinking the approach
            - Document the issue
            - Propose alternative approach

            **E) Factory/Workflow Bug** - The CI/CD pipeline itself is broken
            - THIS IS THE MOST COMMON REASON FOR ESCALATION!
            - Workflow syntax errors, install script issues, lock file problems
            - Fix the workflow file directly
            - See "Factory Diagnosis" section below

            ### Step 3.5: Factory Diagnosis (CRITICAL - DO THIS FIRST!)

            Before assuming it's a code bug, check if the factory itself is broken:

            ```bash
            # Check recent workflow runs for the Code Agent
            gh run list --workflow=bug-fix.yml --limit 5 --json databaseId,conclusion,createdAt

            # Get logs from failed runs
            FAILED_RUN=$(gh run list --workflow=bug-fix.yml --status=failure --limit 1 --json databaseId -q '.[0].databaseId')
            gh run view $FAILED_RUN --log-failed 2>/dev/null | tail -100

            # Look for common factory failures:
            # - "Installation failed" ‚Üí install script syntax error
            # - "lock" or "another process" ‚Üí lock file issue
            # - "Permission denied" ‚Üí PAT_WITH_WORKFLOW_ACCESS missing/wrong
            # - "rate limit" ‚Üí API throttling
            # - "timeout" ‚Üí step taking too long
            ```

            **Common Factory Fixes:**

            | Error Pattern | Likely Cause | Fix |
            |--------------|--------------|-----|
            | `Installation failed` | Bad install script args | Check `curl ... \| bash -s --` syntax |
            | `another process is currently installing` | Lock file | Add `rm -f ~/.claude/.installing` before install |
            | `Permission denied` on workflow | Missing PAT | Check PAT_WITH_WORKFLOW_ACCESS secret |
            | `Usage: bash [stable\|latest\|VERSION]` | Invalid flags | Remove invalid flags from install command |
            | `rate limit exceeded` | API throttling | Add retry with backoff |
            | Step timeout | Hanging process | Add timeout or fix infinite loop |

            **If you find a factory bug:**
            1. Fix the workflow file (bug-fix.yml, ci.yml, etc.)
            2. Commit with message explaining the factory bug
            3. The original issue will auto-retry once factory is fixed
            4. Update CLAUDE.md with the learning

            ### Step 4: Implement Fix
            Based on root cause:
            - Create branch: `git checkout -b fix/${{ steps.context.outputs.number }}-pe-fix`
            - Make necessary changes
            - Run quality gates
            - Create PR with "Fixes #${{ steps.context.outputs.number }}" in body

            ### Step 5: Prevent Recurrence (CRITICAL!)
            This is what makes you different from Code Agent:

            **Always ask:** "How do I prevent this class of problem from happening again?"

            Options:
            - Update workflow prompts in `.github/workflows/bug-fix.yml`
            - Add rules to `CLAUDE.md`
            - Improve E2E test infrastructure in `ci.yml`
            - Add better error handling to code
            - Create new tests for edge cases

            **IMPORTANT: Document factory learnings for posterity!**
            After fixing a factory issue, create a closed `factory-improvement` issue:
            ```bash
            gh issue create --label "factory-improvement" \
              --title "Factory Fix: [brief description]" \
              --body "## Problem
            [What went wrong]

            ## Root Cause
            [Why it happened]

            ## Solution
            [What you changed]

            ## PR
            PR #[number]"

            gh issue close [new_issue_number] --comment "Fixed in PR #[number]"
            ```
            This creates a searchable audit trail of factory learnings.

            ## Progress Comment Format
            Update comment #${{ steps.progress.outputs.comment_id }} as you work:
            ```bash
            gh api repos/${{ github.repository }}/issues/comments/${{ steps.progress.outputs.comment_id }} \
              -X PATCH -f body="## üîß Principal Engineer Investigation

            - [x] üìñ Reading full issue history and understanding context
            - [x] üìä Analyzing CI failures and downloading artifacts
            - [x] üîç Identifying root cause (code bug vs infrastructure vs workflow)
            - [ ] üõ†Ô∏è Implementing fix
            - [ ] üè≠ Updating factory to prevent recurrence
            - [ ] üìù Creating factory-improvement issue for audit trail
            - [ ] ‚úÖ Verifying fix works

            **Status:** [current status]
            **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            ## üîç Root Cause Analysis

            ### What Happened
            [Summary of why Code Agent got stuck]

            ### Root Cause
            [Detailed explanation - is it code bug, test infra, workflow issue, or architecture?]

            ### Fix Plan
            1. [Immediate fix]
            2. [Factory improvement to prevent recurrence]

            ### E2E Logs Analysis (if applicable)
            [Key findings from backend.log or Playwright reports]

            cc @${{ steps.context.outputs.issue_author }}"
            ```

            ## Git Commit Rules
            - Use "Relates to #${{ steps.context.outputs.number }}" in commits
            - Use "Fixes #${{ steps.context.outputs.number }}" only in PR description
            - NEVER push directly to main

            ## If Truly Stuck - Escalation Criteria

            **ONLY escalate to human if ALL of the following are true:**

            1. ‚úÖ You've done factory diagnosis (checked workflow logs for common errors)
            2. ‚úÖ You've verified it's NOT a workflow/infrastructure bug
            3. ‚úÖ You've tried at least 2 different approaches
            4. ‚úÖ The issue requires a DECISION you cannot make:
               - Security implications (credentials, auth)
               - Breaking API changes
               - Business/product decisions
               - Major architecture changes
               - Cost implications

            **DO NOT escalate for:**
            - ‚ùå Workflow syntax errors (FIX THEM!)
            - ‚ùå Install/dependency issues (FIX THEM!)
            - ‚ùå Flaky tests (FIX OR SKIP THEM!)
            - ‚ùå Unclear requirements (MAKE A REASONABLE CHOICE!)
            - ‚ùå "I'm not sure which approach is better" (PICK ONE!)

            **If you must escalate:**
            1. Document everything you tried (with specifics)
            2. Explain WHY this needs human judgment (not just "I'm stuck")
            3. Provide 2-3 specific options for the human to choose from
            4. @mention @your-github-username with the specific decision needed
            5. Set label: status:awaiting-human

            **Remember:** Every human escalation is a factory bug. If you're escalating for
            something an agent COULD fix, that's a bug in your instructions - fix THAT instead!

          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --dangerously-skip-permissions
            --allowedTools "Bash(gh:*),Bash(git:*),Bash(npm:*),Bash(cd:*),Bash(uv:*),Bash(cat:*),Bash(ls:*),Read,Write,Edit,Glob,Grep"
        env:
          GH_TOKEN: ${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}
          GITHUB_TOKEN: ${{ secrets.PAT_WITH_WORKFLOW_ACCESS }}

      - name: Update status on success
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.context.outputs.number }} \
            --remove-label "status:bot-working" 2>/dev/null || true

      - name: Handle failure - Factory Diagnosis
        if: failure()
        id: diagnosis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Running factory diagnosis before escalating..."

          # Get failed logs from this run
          FAILED_LOGS=$(gh run view ${{ github.run_id }} --log-failed 2>/dev/null | tail -50 || echo "Could not fetch logs")

          # Check for common factory issues
          FACTORY_ISSUE=""
          if echo "$FAILED_LOGS" | grep -qi "installation failed\|Usage: bash"; then
            FACTORY_ISSUE="Install script syntax error - check curl ... | bash -s -- arguments"
          elif echo "$FAILED_LOGS" | grep -qi "another process\|lock"; then
            FACTORY_ISSUE="Lock file issue - add cleanup before install"
          elif echo "$FAILED_LOGS" | grep -qi "permission denied\|403"; then
            FACTORY_ISSUE="Permission issue - check PAT_WITH_WORKFLOW_ACCESS secret"
          elif echo "$FAILED_LOGS" | grep -qi "rate limit"; then
            FACTORY_ISSUE="Rate limiting - add retry with backoff"
          elif echo "$FAILED_LOGS" | grep -qi "timeout"; then
            FACTORY_ISSUE="Timeout - step taking too long, may need optimization"
          fi

          if [ -n "$FACTORY_ISSUE" ]; then
            echo "is_factory_bug=true" >> $GITHUB_OUTPUT
            echo "diagnosis=$FACTORY_ISSUE" >> $GITHUB_OUTPUT
            echo "üè≠ Detected factory bug: $FACTORY_ISSUE"
          else
            echo "is_factory_bug=false" >> $GITHUB_OUTPUT
            echo "diagnosis=Unknown failure - may need human review" >> $GITHUB_OUTPUT
            echo "‚ùì Could not auto-diagnose, may need human review"
          fi

          # Save logs for comment
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_LOGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Handle failure - Update and Escalate
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROGRESS_COMMENT_ID: ${{ steps.progress.outputs.comment_id }}
          ISSUE_AUTHOR: ${{ steps.context.outputs.issue_author }}
          IS_FACTORY_BUG: ${{ steps.diagnosis.outputs.is_factory_bug }}
          DIAGNOSIS: ${{ steps.diagnosis.outputs.diagnosis }}
        run: |
          if [ -n "$PROGRESS_COMMENT_ID" ]; then
            gh api repos/${{ github.repository }}/issues/comments/$PROGRESS_COMMENT_ID \
              -X PATCH -f body="## üîß Principal Engineer Investigation

          - [x] üìñ Reading full issue history
          - [x] üîç Running factory diagnosis
          - [?] Investigation incomplete (workflow failed)

          **Status:** ‚ùå Workflow failed - see logs
          **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          ## üè≠ Factory Diagnosis

          **Is Factory Bug:** ${IS_FACTORY_BUG}
          **Diagnosis:** ${DIAGNOSIS}

          $(if [ \"$IS_FACTORY_BUG\" = \"true\" ]; then echo \"‚ö†Ô∏è This appears to be a factory/workflow bug, not a code bug. A human should fix the workflow file, then retry.\"; else echo \"This may require human review to determine the root cause.\"; fi)

          @your-github-username - please investigate.

          cc @${ISSUE_AUTHOR}" 2>/dev/null || true
          fi

          # Different message based on whether it's a factory bug
          if [ "$IS_FACTORY_BUG" = "true" ]; then
            gh issue comment ${{ steps.context.outputs.number }} --body "## üè≠ Factory Bug Detected

          The Principal Engineer identified this as a **factory/workflow bug**, not a code bug.

          **Diagnosis:** ${DIAGNOSIS}

          **Recommended Action:**
          1. Fix the workflow file (likely \`.github/workflows/bug-fix.yml\` or \`ci.yml\`)
          2. Once fixed, remove \`needs-human\` label to retry

          [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          @your-github-username

          cc @${ISSUE_AUTHOR}"
          else
            gh issue comment ${{ steps.context.outputs.number }} --body "## üö® Principal Engineer Needs Help

          The Principal Engineer was unable to resolve this automatically.

          **Diagnosis:** ${DIAGNOSIS}

          **Next steps:**
          1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. Determine if this is a code bug, workflow bug, or needs a design decision

          @your-github-username

          cc @${ISSUE_AUTHOR}"
          fi

          gh issue edit ${{ steps.context.outputs.number }} \
            --remove-label "status:bot-working" \
            --add-label "needs-human" \
            --add-label "status:awaiting-human"
