name: CI Watcher

# Watches CI runs and posts regular status updates to related issues
on:
  workflow_run:
    workflows: ["CI/CD"]
    types: [requested, in_progress, completed]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read
  checks: read

jobs:
  watch-ci:
    runs-on: ubuntu-latest
    # Only watch CI runs on PRs (not direct pushes to main)
    if: github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR and Issue info
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "CI Run ID: $RUN_ID"
          echo "Branch: $HEAD_BRANCH"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          # Extract issue number from branch name
          # Patterns supported:
          #   fix/123-desc, feat/123-desc (Code Agent)
          #   claude/qa-*-123, claude/*-123 (QA Agent and other Claude branches)
          ISSUE_NUMBER=""
          if [[ "$HEAD_BRANCH" =~ ^(fix|feat)/([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[2]}"
            echo "Found issue number from fix/feat pattern: $ISSUE_NUMBER"
          elif [[ "$HEAD_BRANCH" =~ -([0-9]+)$ ]]; then
            # Issue number at end of branch name (e.g., claude/qa-coverage-sprint-169)
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "Found issue number from branch suffix: $ISSUE_NUMBER"
          else
            echo "Branch doesn't match any issue pattern, skipping"
            echo "issue_number=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Get PR number
          PR_NUMBER=$(gh pr list --repo ${{ github.repository }} \
            --head "$HEAD_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR: $PR_NUMBER"

          # Get issue author for @mentions
          if [ -n "$ISSUE_NUMBER" ]; then
            ISSUE_AUTHOR=$(gh issue view "$ISSUE_NUMBER" --repo ${{ github.repository }} \
              --json author --jq '.author.login' 2>/dev/null || echo "")
            echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT
          fi

      - name: Find or create CI status comment
        if: steps.context.outputs.issue_number != ''
        id: comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
        run: |
          # Look for existing CI status comment (marked with hidden identifier)
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
            --jq '.[] | select(.body | contains("<!-- ci-watcher -->")) | .id' 2>/dev/null | tail -1 || echo "")

          if [ -n "$COMMENT_ID" ]; then
            echo "Found existing CI status comment: $COMMENT_ID"
            echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
            echo "is_new=false" >> $GITHUB_OUTPUT
          else
            # Create new comment
            BODY="<!-- ci-watcher -->
          ## üîÑ CI Status

          **Status:** Starting...
          **Run:** [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ steps.context.outputs.run_id }})

          | Job | Status | Duration |
          |-----|--------|----------|
          | ... | ‚è≥ Waiting | - |

          *Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

            COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
              -X POST -f body="$BODY" --jq '.id')
            echo "Created new CI status comment: $COMMENT_ID"
            echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
            echo "is_new=true" >> $GITHUB_OUTPUT
          fi

      - name: Update CI status (in progress)
        if: |
          steps.context.outputs.issue_number != '' &&
          github.event.workflow_run.status == 'in_progress'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          COMMENT_ID: ${{ steps.comment.outputs.comment_id }}
          RUN_ID: ${{ steps.context.outputs.run_id }}
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
        run: |
          set +e  # Don't exit on errors

          # Poll and update every 5 minutes for up to 30 minutes
          for i in $(seq 1 6); do
            echo "Update check $i/6..."

            # Get current job statuses as formatted table directly
            TABLE=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs --jq '
              .jobs |
              ["| Job | Status | Duration |", "|-----|--------|----------|"] +
              [.[] |
                "| \(.name) | " +
                (if .conclusion == "success" then "‚úÖ"
                 elif .conclusion == "failure" then "‚ùå"
                 elif .conclusion == "skipped" then "‚è≠Ô∏è"
                 elif .status == "in_progress" then "üîÑ"
                 elif .status == "queued" then "‚è≥"
                 else "‚è∏Ô∏è" end) +
                " \(.conclusion // .status) | " +
                (if .completed_at and .started_at then
                   (((.completed_at | fromdateiso8601) - (.started_at | fromdateiso8601)) | tostring) + "s"
                 elif .started_at then "running"
                 else "-" end) +
                " |"
              ] | join("\n")
            ' 2>/dev/null || echo "| Error fetching jobs | ‚ùì | - |")

            # Get summary stats
            STATS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs --jq '
              .jobs | {
                total: length,
                completed: [.[] | select(.status == "completed")] | length,
                failed: [.[] | select(.conclusion == "failure")] | length
              } | "\(.completed)/\(.total) complete, \(.failed) failed"
            ' 2>/dev/null || echo "unknown")

            # Update comment
            BODY="<!-- ci-watcher -->
          ## üîÑ CI Status

          **Status:** üîÑ **Running:** $STATS
          **PR:** #$PR_NUMBER
          **Run:** [View logs](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)

          $TABLE

          *Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
              -X PATCH -f body="$BODY" 2>/dev/null || echo "Failed to update comment"

            # Check if run is still in progress
            RUN_STATUS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID --jq '.status' 2>/dev/null || echo "unknown")
            if [ "$RUN_STATUS" != "in_progress" ] && [ "$RUN_STATUS" != "queued" ]; then
              echo "Run no longer in progress ($RUN_STATUS), exiting poll loop"
              break
            fi

            # Wait 5 minutes before next update
            if [ $i -lt 6 ]; then
              echo "Sleeping 5 minutes..."
              sleep 300
            fi
          done

          echo "Polling complete"

      - name: Handle CI completion
        if: |
          steps.context.outputs.issue_number != '' &&
          github.event.workflow_run.status == 'completed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          COMMENT_ID: ${{ steps.comment.outputs.comment_id }}
          RUN_ID: ${{ steps.context.outputs.run_id }}
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
          ISSUE_AUTHOR: ${{ steps.context.outputs.issue_author }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        run: |
          set +e  # Don't exit on errors
          echo "CI completed with conclusion: $CONCLUSION"

          # Get final job statuses as formatted table
          TABLE=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs --jq '
            .jobs |
            ["| Job | Status | Duration |", "|-----|--------|----------|"] +
            [.[] |
              "| \(.name) | " +
              (if .conclusion == "success" then "‚úÖ"
               elif .conclusion == "failure" then "‚ùå"
               elif .conclusion == "skipped" then "‚è≠Ô∏è"
               elif .conclusion == "cancelled" then "üö´"
               else "‚ùì" end) +
              " \(.conclusion // "unknown") | " +
              (if .completed_at and .started_at then
                 (((.completed_at | fromdateiso8601) - (.started_at | fromdateiso8601)) | tostring) + "s"
               else "-" end) +
              " |"
            ] | join("\n")
          ' 2>/dev/null || echo "| Error fetching jobs | ‚ùì | - |")

          # Get failed job names
          FAILED_JOBS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs --jq '
            [.jobs[] | select(.conclusion == "failure") | .name] | join(", ")
          ' 2>/dev/null || echo "unknown")

          # Final status message
          if [ "$CONCLUSION" == "success" ]; then
            STATUS_MSG="## ‚úÖ CI Passed!

          All checks passed. PR #$PR_NUMBER is ready for merge."

            # Auto-merge if possible
            echo "Attempting auto-merge..."
            if gh pr merge "$PR_NUMBER" --repo ${{ github.repository }} --squash --delete-branch 2>/dev/null; then
              STATUS_MSG="## ‚úÖ CI Passed & Merged!

          All checks passed. PR #$PR_NUMBER has been automatically merged.
          üöÄ **Deploying to production...**"

              # Explicitly close issues referenced with "Fixes #N" or "Closes #N"
              # GitHub's auto-close doesn't work when merging via API/CLI
              PR_BODY=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json body --jq '.body' 2>/dev/null || echo "")
              FIXED_ISSUES=$(echo "$PR_BODY" | grep -oE '(Fixes|Closes|Resolves) #[0-9]+' | grep -oE '[0-9]+' || echo "")
              for FIXED_ISSUE in $FIXED_ISSUES; do
                echo "Closing related issue #$FIXED_ISSUE..."
                gh issue close "$FIXED_ISSUE" --repo ${{ github.repository }} \
                  --comment "Closed by PR #$PR_NUMBER" 2>/dev/null || echo "Failed to close #$FIXED_ISSUE"
              done
            fi
          else
            STATUS_MSG="## ‚ùå CI Failed

          **Failed jobs:** $FAILED_JOBS

          [View failure logs](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)

          üîÑ Code Agent will automatically retry..."
          fi

          # Update comment with final status
          BODY="<!-- ci-watcher -->
          $STATUS_MSG

          **PR:** #$PR_NUMBER
          **Run:** [View logs](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)

          $TABLE

          *Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*

          cc @$ISSUE_AUTHOR"

          gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            -X PATCH -f body="$BODY" 2>/dev/null || echo "Failed to update comment"

          # If failed, trigger Code Agent retry (unless already at limit)
          if [ "$CONCLUSION" == "failure" ]; then
            FAILURE_COUNT=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
              --jq '[.[] | select(.body | contains("‚ùå CI Failed"))] | length' 2>/dev/null || echo "0")

            if [ "$FAILURE_COUNT" -lt 3 ]; then
              echo "Triggering Code Agent retry (attempt $((FAILURE_COUNT + 1)) of 3)..."
              gh workflow run bug-fix.yml --repo ${{ github.repository }} \
                -f issue_number="$ISSUE_NUMBER" 2>/dev/null || echo "Failed to trigger retry"
            else
              echo "CI has failed 3+ times, escalating to human"
              gh issue edit "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                --add-label "needs-principal-engineer" 2>/dev/null || true
            fi
          fi
